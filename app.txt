from fileinput import filename
import os
import uuid
from datetime import datetime
import webbrowser
import threading
import dash
from dash import dcc, html, Input, Output, State, no_update, ALL, callback_context
from dash.exceptions import PreventUpdate
import dash_bootstrap_components as dbc
from dash import dash_table
from utils.constants import (APP_TITLE, TAB_FINANCIAL_LABEL, TAB_REFERENCE_LABEL, EXPECTED_COLUMNS_DEFAULT, KEY_COLUMN, HEADER_SCAN_COLS_MAX, HEADER_SCAN_ROWS_MAX,)
from services.file_io import save_uploaded_xlsx, ensure_session_dir, cleanup_session_dir, extract_latest_mastergroup_date
from services.run_date_parser import extract_run_date_from_xlsx
from services.schema_detector import detect_header_row
from services.diff_engine import run_reference_check
from services.report_writer import write_anomaly_report_xlsx

# Financial tab imports
from utils.constants import (FINANCIAL_KEY_COLUMNS, FINANCIAL_NON_FINANCIAL_COLUMNS, 
                             FINANCIAL_FUZZY_THRESHOLD, FINANCIAL_EXPECTED_COLUMNS)
from services.financial_engine import (run_mastergroup_validation, run_non_financial_comparison,
                                      run_financial_comparison, build_consolidated, _read_financial_file,
                                      validate_financial_files)
from services.financial_report_writer import write_financial_report_xlsx

app = dash.Dash(__name__,title=APP_TITLE, external_stylesheets=[dbc.themes.FLATLY],suppress_callback_exceptions=True)

server = app.server

def default_compare_columns():
    return [c for c in EXPECTED_COLUMNS_DEFAULT if c != KEY_COLUMN]

def _upload_box():
    return dcc.Upload(
        id="ref_upload",
        multiple=True,
        children=dbc.Card(
            dbc.CardBody(
                [
                    html.Div(
                        [
                            html.Div("Drag & drop files here",className="fw-semibold"),
                            html.Div("or click to select files",className="text-muted small"),
                        ],
                        className="text-center"
                    )
                ],
                className="py-4"
            ),
            className="border border-2 border-secondary border-opacity-25",style={"borderStyle": "dashed", "padding": "20px", "cursor": "pointer"}
        ),
        style={"width": "100%","cursor": "pointer"},
    )

def _current_main_alert_content(filename, run_date_display):
    if not filename:
        return "Current/Main file: -"

    pill_text = f"{filename} | {run_date_display or ''}".strip()
    return html.Div(
        className="d-flex flex-wrap align-items-center gap-2",
        children=[
            html.Span("Current/Main file:", className="fw-semibold"),
            html.Span(
                pill_text,
                className="px-2 py-1 rounded",
                style={
                    "backgroundColor": "#d1e7dd",
                    "color": "#0f5132",
                    "fontWeight": "600",
                    },
                    ),
        ],
    )

def _clickable_stat_card(btn_id: str, title:str, value:int, is_active:bool):
    border = "2px solid #0d6efd" if is_active else "1px solid #dee2e6"
    return dbc.Button(
        id=btn_id,
        n_clicks=0,
        color="light",
        className="p-0 w-100 text-start",
        style={
            "border": border
        },
        children=dbc.Card(
            className="shadow-sm border-0",
            children=[
                dbc.CardBody(
                    [
                        html.Div(title, className="text-muted small"),
                        html.Div(str(value), className="fs-3 fw-bold"),
                        html.Div("Click to filter table", className="text-muted small")
                    ],
                )
            ]   
        )
    )

def _summary_cards_clickable(summary, active_filter):
    return dbc.Row(
        className="g-3",
        children=[
            dbc.Col(
                _clickable_stat_card(
                    btn_id="card_added",
                    title="Added rows",
                    value=int(summary.get("added_rows", 0)),
                    is_active=(active_filter == "added")

                ),md=4
            ),
            dbc.Col(
                _clickable_stat_card(
                    btn_id="card_deleted",
                    title="Deleted rows",
                    value=int(summary.get("deleted_rows", 0)),
                    is_active=(active_filter == "deleted")
                ),md=4
            ),
            dbc.Col(
                _clickable_stat_card(
                    btn_id="card_modified",
                    title="Modified rows",
                    value=int(summary.get("modified_rows", 0)),
                    is_active=(active_filter == "modified")
                ),md=4
            ),
        ]
    )

def reference_tab_layout():
    compare_opts = [{"label": col, "value": col} for col in default_compare_columns()]

    return dbc.Container(
        fluid=True,
        className="py-3",
        children=[
            dbc.Row(
                className="mb-2",
                children=[
                    dbc.Col(
                        md=12,
                        children=dbc.Button(
                            "Clear Session",
                            id="ref_clear_session_btn",
                            color="outline-danger",
                            className="me-auto"
                        )
                    )
                ]
            ),

            dbc.Row(
                className="g-3 align-items-stretch",
                children=[
                    dbc.Col(
                        md=6,
                        children=dbc.Card(
                            className="h-100 shadow-sm",
                            children=[
                                dbc.CardHeader(
                                    html.Div(
                                        [
                                            html.Span("Upload Data", className="fw-semibold"),
                                            html.Span(" - Upload multiple .xlsx files", className="text-muted small")
                                        ]
                                    )
                                ),
                                dbc.CardBody(
                                    className="d-flex flex-column",
                                    children=[
                                        _upload_box(),
                                        html.Div(className="mt-3"),
                                        dcc.Loading(
                                            type="default",
                                            children=[dbc.Alert(id="ref_upload_status", color='info',className="py-2 mb-3",children="Upload files to begin."),
                                                      html.Div(
                                                          id="ref_files_table_wrapper",
                                                          children=dbc.Alert(
                                                              "No files uploaded yet.",
                                                              color="secondary",
                                                              className="mb-0"
                                                          )
                                                      )]
                                        )
                                    ]
                                )
                            ]
                        )
                    ),
                    dbc.Col(
                      md=6,
                        children=dbc.Card(
                            className="h-100 shadow-sm",
                            children=[
                                dbc.CardHeader(
                                    html.Div([
                                        html.Span("File Selection", className="fw-semibold"),
                                        html.Span(" - Auto-selects if all files pass date check", className="text-muted small"),
                                    ]
                                    )
                                ),
                                dbc.CardBody(
                                    children=[
                                        html.Div(
                                            id="manual_current_selection_wrapper",
                                            style={"display": "none"},
                                            children=[
                                                dbc.Label("Current period data:"),
                                                dcc.Dropdown(
                                                    id="ref_current_dropdown",
                                                    options=[],
                                                    value=None,
                                                    placeholder="Select current file",
                                                    clearable=False,
                                                ),
                                                html.Div(className="mb-3"),
                                            ]
                                        ),
                                        dcc.Loading(
                                            type="default",
                                            children=dbc.Alert(
                                                id="ref_current_main_alert",
                                                color="primary",
                                                className="py-2",
                                                children="Current period data: ",
                                            ),
                                        ),
                                        html.Div(className="mt-3"),
                                        dbc.Label("Previous period data: "),
                                        dcc.Dropdown(
                                            id="ref_reference_dropdown",
                                            options=[],
                                            value=None,
                                            placeholder="Upload at least 2 valid files to select reference",
                                            clearable=False,
                                            ),
                                    ],
                                ),
                            ],
                        ),
                    ),
                ],
            ),

            html.Div(
                id="post_reference_sections",
                style={"display": "none"},
                children=[
                    dbc.Row(
                        className="g-3 mt-1",
                        children=[
                            dbc.Col(
                                md=12,
                                children=dbc.Card(
                                    className="shadow-sm",
                                    children=[
                                        dbc.CardHeader(
                                            html.Div([
                                                html.Span("Comparison Settings", className="fw-semibold"),
                                            ])
                                        ),
                                        dbc.CardBody(
                                            className="p-4",
                                            children=[
                                                dbc.Row(className="g-3",
                                                    children=[
                                                        dbc.Col(
                                                            md=6,
                                                            children=[
                                                                dbc.Label("Key column"),
                                                                dbc.InputGroup(
                                                                    [
                                                                        dbc.Input(value=KEY_COLUMN, disabled=False),
                                                                        dbc.InputGroupText("default"),
                                                            ]
                                                        ),
                                                        dbc.FormText("Used to match rows between Current and Previous Data."),
                                                    ],),
                                                    dbc.Col(
                                                    md=6,
                                                    children=[
                                                        dbc.Label("Compare columns (optional)"),
                                                        dcc.Dropdown(
                                                            id="compare_columns_dropdown",
                                                            options=compare_opts,
                                                            multi=True,
                                                            placeholder="Leave empty to compare all inscope columns",
                                                        ),
                                                    ],
                                                ),  
                                            ]),
                                            
                                            ],
                                        ),
                                        html.Hr(className="my-3"),
                                        dbc.Accordion(
                                            className="pt-3",
                                            start_collapsed=True,
                                            children=[
                                                dbc.AccordionItem(
                                                    title="Manual header detection (optional)",
                                                    children=[
                                                        dbc.Row(
                                                            className="g-3",
                                                            children=[
                                                                dbc.Col(
                                                                    md=6,
                                                                    children=[
                                                                        dbc.Label("Current data header row (1-based)"),
                                                                        dbc.Input(
                                                                            id="main_header_override",
                                                                            type="number",
                                                                            min=1,
                                                                            step=1,
                                                                            placeholder="Leave empty to auto-detect",
                                                                        ),
                                                                    ],
                                                                ),
                                                                dbc.Col(
                                                                    md=6,
                                                                    children=[
                                                                        dbc.Label("Previous data header row (1-based)"),
                                                                        dbc.Input(
                                                                            id="ref_header_override",
                                                                            type="number",
                                                                            min=1,
                                                                            step=1,
                                                                            placeholder="Leave empty to auto-detect",
                                                                ),
                                                            ],
                                                        ),
                                                    ],
                                                ),
                                            ],
                                        ),
                                    ],       
                                ),
                                html.Div(className="mt-3"),
                                dbc.Row(
                                    className="g-2 align-items-center mb-3 ps-2",
                                    children=[
                                        dbc.Col(
                                            md=3,
                                            children=dbc.Button(
                                                ["Run Comparison"],
                                                id="run_compare_btn",
                                                color="primary",
                                                className="w-100",
                                            ),
                                        ),
                                    ],
                                ),
                            ],
                        ) 
                    )
                ],
            ),
        ]
    ),
            dbc.Row(
                className="g-3 mt-1",
                children=[
                    dbc.Col(
                        md=12,
                        children=dbc.Card(
                            className="shadow-sm",
                            children=[
                                dbc.CardHeader(
                                    html.Div(
                                        [
                                            html.Span("Comparison Summary", className="fw-semibold"),
                                            html.Span(" - Click a card to filter table", className="text-muted small"),
                                        ]
                                    )
                                ),
                                dbc.CardBody(
                                    children=[
                                        html.Div(id="summary_cards_area"),
                                        html.Div(id="active_filter_hint", className="text-muted small mt-2"),
                                        html.Hr(className="my-3"),
                                        dcc.Loading(
                                            type="default",
                                            children=[
                                                dash_table.DataTable(
                                                    id="anomaly_table",
                                                    columns=[
                                                        {"name": "Change Type", "id": "change_type"},
                                                        {"name": "Key", "id": "key"},
                                                        {"name": "Column Name", "id": "column_name"},
                                                        {"name": "Current Value", "id": "old_value"},
                                                        {"name": "Previous Value", "id": "new_value"},
                                                    ],
                                                    data=[],
                                                    page_size=10,
                                                    filter_action="native",
                                                    sort_action="native",
                                                    style_table={"overflowX": "auto"},
                                                    style_cell={
                                                        "padding": "8px",
                                                        "fontSize": "13px",
                                                        "maxWidth": "260px",
                                                        "overflow": "hidden",
                                                        "textOverflow": "ellipsis",
                                                    },
                                                    style_header={
                                                        "backgroundColor": "#f8f9fa",
                                                        "fontWeight": "bold",
                                                    },
                                                )
                                            ]
                                        ),
                                        html.Div(className="mt-3"),
                                        dbc.Row(
                                            className="g-2 align-items-center",
                                            children=[
                                                dbc.Col(
                                                    md=3,
                                                    children=dbc.Button(
                                                        "Download Anomaly Report (.xlsx)",
                                                        id="download_btn",
                                                        color="success",
                                                        className="w-100",
                                                    ),
                                                ),
                                                dbc.Col(
                                                    md=9,
                                                    children=dbc.Alert(
                                                        id="download_hint",
                                                        color="secondary",
                                                        className="py-2 mb-0",
                                                        children="Run comparison to enable report download.",
                                                    )
                                                ),
                                            ]
                                        )
                                    ]
                                )
                            ]
                        )
                    )
                ]
            ),
            dcc.Download(id="report_download")
        ],
    )

def financial_tab_layout():
    """Financial Data Reconciliation tab layout"""
    
    compare_opts = [{"label": col, "value": col} for col in FINANCIAL_NON_FINANCIAL_COLUMNS]
    
    return dbc.Container(
        fluid=True,
        className="py-3",
        children=[
            # Clear session button
            dbc.Row(
                className="mb-2",
                children=[
                    dbc.Col(
                        md=12,
                        children=dbc.Button(
                            "Clear Session",
                            id="fin_clear_session_btn",
                            color="outline-danger",
                            className="me-auto"
                        )
                    )
                ]
            ),
            
            # Upload and File Selection Row
            dbc.Row(
                className="g-3 align-items-stretch",
                children=[
                    # Upload Card
                    dbc.Col(
                        md=6,
                        children=dbc.Card(
                            className="h-100 shadow-sm",
                            children=[
                                dbc.CardHeader(
                                    html.Div([
                                        html.Span("Upload Financial Data", className="fw-semibold"),
                                        html.Span(" - Upload exactly 2 .xlsx files (GBM or CMB)", className="text-muted small")
                                    ])
                                ),
                                dbc.CardBody(
                                    className="d-flex flex-column",
                                    children=[
                                        dcc.Upload(
                                            id="fin_upload",
                                            multiple=True,
                                            children=html.Div([
                                                html.I(className="bi bi-cloud-upload me-2"),
                                                "Drag and Drop or Click to Select Files"
                                            ]),
                                            style={
                                                "width": "100%",
                                                "height": "80px",
                                                "lineHeight": "80px",
                                                "borderWidth": "2px",
                                                "borderStyle": "dashed",
                                                "borderRadius": "8px",
                                                "textAlign": "center",
                                                "cursor": "pointer",
                                                "backgroundColor": "#f8f9fa"
                                            }
                                        ),
                                        html.Div(className="mt-3"),
                                        dcc.Loading(
                                            type="default",
                                            children=[
                                                dbc.Alert(
                                                    id="fin_upload_status",
                                                    color="info",
                                                    className="py-2 mb-3",
                                                    children="Upload 2 files to begin."
                                                ),
                                                html.Div(
                                                    id="fin_files_table_wrapper",
                                                    children=dbc.Alert(
                                                        "No files uploaded yet.",
                                                        color="secondary",
                                                        className="mb-0"
                                                    )
                                                )
                                            ]
                                        )
                                    ]
                                )
                            ]
                        )
                    ),
                    
                    # File Selection Card
                    dbc.Col(
                        md=6,
                        children=dbc.Card(
                            className="h-100 shadow-sm",
                            children=[
                                dbc.CardHeader(
                                    html.Div([
                                        html.Span("File Selection", className="fw-semibold"),
                                        html.Span(" - Select current and previous files", className="text-muted small")
                                    ])
                                ),
                                dbc.CardBody(
                                    children=[
                                        dbc.Label("Current period data:"),
                                        dcc.Dropdown(
                                            id="fin_current_dropdown",
                                            options=[],
                                            value=None,
                                            placeholder="Select current file",
                                            clearable=False,
                                        ),
                                        html.Div(className="mb-3"),
                                        dbc.Label("Previous period data:"),
                                        dcc.Dropdown(
                                            id="fin_previous_dropdown",
                                            options=[],
                                            value=None,
                                            placeholder="Select previous file",
                                            clearable=False,
                                        ),
                                        html.Div(className="mt-3"),
                                        dbc.Alert(
                                            id="fin_selection_status",
                                            color="info",
                                            className="py-2 mb-0",
                                            children="Upload files and select current/previous to continue."
                                        ),
                                        html.Div(className="mt-3"),
                                        dbc.Button(
                                            "Validate Data",
                                            id="fin_validate_btn",
                                            color="info",
                                            className="w-100",
                                            disabled=True
                                        ),
                                        html.Div(className="mt-3"),
                                        dcc.Loading(
                                            type="default",
                                            children=html.Div(id="fin_validation_preview")
                                        )
                                    ]
                                )
                            ]
                        )
                    )
                ]
            ),
            
            # Comparison Settings (shown after file selection)
            html.Div(
                id="fin_comparison_section",
                style={"display": "none"},
                children=[
                    dbc.Row(
                        className="g-3 mt-1",
                        children=[
                            dbc.Col(
                                md=12,
                                children=dbc.Card(
                                    className="shadow-sm",
                                    children=[
                                        dbc.CardHeader(
                                            html.Div([
                                                html.Span("Comparison Settings", className="fw-semibold")
                                            ])
                                        ),
                                        dbc.CardBody(
                                            className="p-4",
                                            children=[
                                                dbc.Row(
                                                    className="g-3",
                                                    children=[
                                                        dbc.Col(
                                                            md=6,
                                                            children=[
                                                                dbc.Label("Key columns (read-only)"),
                                                                dbc.InputGroup([
                                                                    dbc.Input(
                                                                        value=", ".join(FINANCIAL_KEY_COLUMNS),
                                                                        disabled=True
                                                                    ),
                                                                    dbc.InputGroupText("composite key")
                                                                ]),
                                                                dbc.FormText("Used to match rows between files.")
                                                            ]
                                                        ),
                                                        dbc.Col(
                                                            md=6,
                                                            children=[
                                                                dbc.Label("Non-financial columns to compare"),
                                                                dcc.Dropdown(
                                                                    id="fin_compare_columns_dropdown",
                                                                    options=compare_opts,
                                                                    value=FINANCIAL_NON_FINANCIAL_COLUMNS,
                                                                    multi=True,
                                                                    placeholder="Select columns to compare"
                                                                ),
                                                                dbc.FormText("All selected by default.")
                                                            ]
                                                        )
                                                    ]
                                                ),
                                                html.Div(className="mt-3"),
                                                dbc.Row(
                                                    className="g-2 align-items-center",
                                                    children=[
                                                        dbc.Col(
                                                            md=3,
                                                            children=dbc.Button(
                                                                "Run Analysis",
                                                                id="fin_run_btn",
                                                                color="primary",
                                                                className="w-100"
                                                            )
                                                        ),
                                                        dbc.Col(
                                                            md=9,
                                                            children=dcc.Loading(
                                                                type="default",
                                                                children=dbc.Alert(
                                                                    id="fin_analysis_status",
                                                                    color="secondary",
                                                                    className="py-2 mb-0",
                                                                    children="Click 'Run Analysis' to start."
                                                                )
                                                            )
                                                        )
                                                    ]
                                                )
                                            ]
                                        )
                                    ]
                                )
                            )
                        ]
                    )
                ]
            ),
            
            # Results Section (shown after analysis)
            html.Div(
                id="fin_results_section",
                style={"display": "none"},
                children=[
                    dbc.Row(
                        className="g-3 mt-1",
                        children=[
                            dbc.Col(
                                md=12,
                                children=dbc.Card(
                                    className="shadow-sm",
                                    children=[
                                        dbc.CardHeader(
                                            html.Div([
                                                html.Span("Analysis Results", className="fw-semibold")
                                            ])
                                        ),
                                        dbc.CardBody(
                                            children=[
                                                dcc.Tabs(
                                                    id="fin_results_tabs",
                                                    value="tab_mastergroup",
                                                    children=[
                                                        dcc.Tab(label="Mastergroup Mapping", value="tab_mastergroup"),
                                                        dcc.Tab(label="Non-Financial Changes", value="tab_nonfinancial"),
                                                        dcc.Tab(label="Financial Comparison", value="tab_financial"),
                                                        dcc.Tab(label="Consolidated Report", value="tab_consolidated")
                                                    ]
                                                ),
                                                # Filter summary cards (no dropdown)
                                                html.Div(
                                                    id="fin_filter_section",
                                                    className="mt-3",
                                                    children=[
                                                        dcc.Store(id="fin_sub_filter", data="all"),  # Hidden store for filter value
                                                        html.Div(id="fin_filter_summary", className="mb-3")
                                                    ]
                                                ),
                                                # Progress indicator for tab rendering
                                                html.Div(
                                                    id="fin_render_progress",
                                                    className="mt-3 mb-2"
                                                ),
                                                # Stores to track which tabs have been rendered
                                                dcc.Store(id="fin_tabs_rendered", data={"mastergroup": False, "nonfinancial": False, "financial": False, "consolidated": False}),
                                                # Pre-rendered tab content divs (toggled with CSS)
                                                html.Div(
                                                    className="mt-3",
                                                    children=[
                                                        html.Div(id="fin_tab_mastergroup_content", style={"display": "block"}),
                                                        html.Div(id="fin_tab_nonfinancial_content", style={"display": "none"}),
                                                        html.Div(id="fin_tab_financial_content", style={"display": "none"}),
                                                        html.Div(id="fin_tab_consolidated_content", style={"display": "none"})
                                                    ]
                                                ),
                                                html.Div(className="mt-3"),
                                                dbc.Row(
                                                    className="g-2 align-items-center",
                                                    children=[
                                                        dbc.Col(
                                                            md=3,
                                                            children=dbc.Button(
                                                                "Download Report (.xlsx)",
                                                                id="fin_download_btn",
                                                                color="success",
                                                                className="w-100"
                                                            )
                                                        ),
                                                        dbc.Col(
                                                            md=9,
                                                            children=dbc.Alert(
                                                                id="fin_download_status",
                                                                color="secondary",
                                                                className="py-2 mb-0",
                                                                children="Report ready for download."
                                                            )
                                                        )
                                                    ]
                                                )
                                            ]
                                        )
                                    ]
                                )
                            )
                        ]
                    )
                ]
            ),
            
            dcc.Download(id="fin_report_download")
        ]
    )

app.layout = dbc.Container(
    fluid=True,
    className="py-3",
    children=[
        # All stores moved here for persistence across tab switches
        # Reference tab stores
        dcc.Store(id="session_store", storage_type="memory"),
        dcc.Store(id="ref_files_store", storage_type="memory"),
        dcc.Store(id="ref_meta_store", storage_type="memory"),
        dcc.Store(id="diff_store", storage_type="memory"),
        dcc.Store(id="report_path_store", storage_type="memory"),
        dcc.Store(id="anomaly_records_store", storage_type="memory"),
        dcc.Store(id="active_filter_store", storage_type="memory", data="all"),
        dcc.Store(id="date_check_mode_store", storage_type="memory"),
        
        # Financial tab stores
        dcc.Store(id="fin_session_store", storage_type="memory"),
        dcc.Store(id="fin_files_store", storage_type="memory"),
        dcc.Store(id="fin_meta_store", storage_type="memory"),
        dcc.Store(id="fin_results_store", storage_type="memory"),
        dcc.Store(id="fin_report_path_store", storage_type="memory"),
        dcc.Store(id="fin_validation_store", storage_type="memory"),
        
        dbc.Row(
            className="mb-3",
            children=[
                dbc.Col(
                    children=[
                        html.H1(APP_TITLE, className="mb-0"),
                        html.Div("Upload, detect current run, compare with a reference run.", className="text-muted")
                    ],
                    md=8
                ),
                dbc.Col(
                    children=[
                        html.Div(
                            "Developed by: Analytics Avengers Team",
                            className="text-end fw-semibold",
                            style={
                                "color": "#0d6efd",
                                "fontSize": "14px",
                                "marginTop": "10px"
                            }
                        )
                    ],
                    md=4
                )
            ]
        ),
        dcc.Tabs(
            id="main_tabs",
            value="reference_tab",
            children=[
                dcc.Tab(label=TAB_REFERENCE_LABEL, value="reference_tab"),
                dcc.Tab(label=TAB_FINANCIAL_LABEL, value="financial_tab"),
            ],
        ),
        # Both tabs rendered always, visibility toggled via CSS
        html.Div(id="reference_tab_wrapper", className="mt-3", children=reference_tab_layout()),
        html.Div(id="financial_tab_wrapper", className="mt-3", style={"display": "none"}, children=financial_tab_layout()),
    ]
)

@app.callback(
    Output("reference_tab_wrapper", "style"),
    Output("financial_tab_wrapper", "style"),
    Input("main_tabs", "value")
)
def render_tab(tab_value):
    """Toggle visibility of tab wrappers to preserve state"""
    if tab_value == "reference_tab":
        return {"display": "block"}, {"display": "none"}
    return {"display": "none"}, {"display": "block"}

@app.callback(
    Output("post_reference_sections", "style"),
    Input("ref_reference_dropdown", "value"),
)
def toggle_post_reference_sections(ref_value):
    if ref_value:
        return {"display": "block"}
    return {"display": "none"}

@app.callback(
    Output("session_store", "data"),
    Output("ref_files_store", "data"),
    Output("ref_meta_store", "data"),
    Output("ref_upload_status", "children"),
    Output("ref_upload_status", "color"),
    Output("ref_current_main_alert", "children"),
    Output("ref_reference_dropdown", "options"),
    Output("ref_reference_dropdown", "value"),
    Output("ref_files_table_wrapper", "children"),
    Output("diff_store", "data"),
    Output("summary_cards_area","children"),
    Output("anomaly_table","data"),
    Output("report_path_store","data"),
    Output("download_hint","children"),
    Output("download_hint","color"),
    Output("anomaly_records_store","data"),
    Output("active_filter_store","data"),
    Output("active_filter_hint","children"),
    Output("manual_current_selection_wrapper", "style"),
    Output("ref_current_dropdown", "options"),
    Output("date_check_mode_store", "data"),
    Input("ref_upload","contents"),
    Input("ref_upload","filename"),
    Input("ref_clear_session_btn","n_clicks"),
    State("session_store","data"),
    State("ref_files_store","data"),
    prevent_initial_call = True
)



def handle_upload(contents_list, filename_list, clear_clicks, session_data, existing_files):
    triggered = dash.callback_context.triggered[0]["prop_id"].split(".")[0]
    
    if triggered == "ref_clear_session_btn":
        if session_data and session_data.get("session_id"):
            cleanup_session_dir(session_data["session_id"])
            
        return (
            None, None, None,
            "Session cleared. Upload files to begin.", "info",
            _current_main_alert_content(None, None),
            [], None,
            dbc.Alert("No files uploaded yet.", color="secondary", className="mb-0"),
            None,
            None,
            [],
            None,
            "Run comparison first to generate a report.",
            "secondary",
            None,
            None,
            "",
            {"display": "none"},  # manual_current_selection_wrapper style
            [],  # ref_current_dropdown options
            None  # date_check_mode_store
            )
        
    if not contents_list or not filename_list:
        return (no_update,) * 21

    session_id = (session_data or {}).get("session_id") or str(uuid.uuid4())
    ensure_session_dir(session_id)

    files = existing_files or []
    invalid_count = 0
    added_count = 0
    
    for contents, fname in zip(contents_list, filename_list):
        file_id = str(uuid.uuid4())
        path = save_uploaded_xlsx(session_id, file_id, fname, contents)
        rd = extract_run_date_from_xlsx(path)
        valid = bool(rd.get("valid"))
        run_dt = rd.get("run_date_parsed")
        
        # Extract latest date from data columns for date check
        latest_date = None
        date_check = False
        if valid and run_dt:
            latest_date = extract_latest_mastergroup_date(path)
            if latest_date and hasattr(latest_date, 'date'):
                # Compare dates (date-only, ignore time)
                date_check = run_dt.date() == latest_date.date()
        
        if not valid or run_dt is None:
            invalid_count += 1
        
        files.append(
            {
                "file_id": file_id,
                "filename": fname,
                "path": path,
                "valid": valid,
                "run_date_iso": run_dt.isoformat() if run_dt else None,
                "run_date_display": run_dt.strftime("%Y-%m-%d %H:%M:%S") if run_dt else "",
                "latest_date": latest_date.strftime("%Y-%m-%d") if latest_date and hasattr(latest_date, 'strftime') else "",
                "date_check": date_check,
                }
                )

        added_count += 1
    valid_files = [f for f in files if f["valid"] and f["run_date_iso"]]
    
    # Check if all valid files pass the date check
    all_pass_date_check = all(f.get("date_check", False) for f in valid_files) if valid_files else False
    manual_mode = False
    date_check_mode = None
    current_options = []
    
    if all_pass_date_check and valid_files:
        # Auto mode: auto-select latest
        current = max(valid_files, key=lambda x: x["run_date_iso"])
        current_id = current["file_id"]
        current_alert = _current_main_alert_content(
            current["filename"],
            current["run_date_display"])
        date_check_mode = "auto"
    elif valid_files:
        # Manual mode: at least one file failed
        current = None
        current_id = None
        manual_mode = True
        date_check_mode = "manual"
        current_alert = dbc.Alert(
            " Some files failed date check. Please select current file manually.",
            color="warning",
            className="py-2"
        )
        # All valid files go to current dropdown
        for f in valid_files:
            current_options.append({"label": f"{f['filename']} (Run: {f['run_date_display']})", "value": f["file_id"]})
    else:
        current = None
        current_id = None
        current_alert = _current_main_alert_content(None, None)

    ref_options = []
    if current:
        for f in valid_files:
            if f["file_id"] == current_id:
                continue
            ref_options.append({"label": f"{f['filename']} (Run: {f['run_date_display']})", "value": f["file_id"]})

    table_rows = []
    for f in files:
        status = "Current (Main)" if (current_id and f["file_id"] == current_id) else "Previous"
        date_status = ""
        if f.get("valid"):
            date_status = " Match" if f.get("date_check") else " Mismatch"
        
        table_rows.append(
            {
                "filename": f["filename"], 
                "run_date": f["run_date_display"] if f["run_date_display"] else "",
                "latest_mastergroup_date": f.get("latest_date", ""),
                "date_status": date_status,
                }
                )

    files_table = dash_table.DataTable(
        id="files_table",
        columns=[
            {"name": "Filename", "id": "filename"},
            {"name": "Run date (parsed)", "id": "run_date"},
            {"name": "Latest date (in file)", "id": "latest_mastergroup_date"},
            {"name": "Date Check Status", "id": "date_status"},
        ],
        data=table_rows,
        style_cell={"padding": "8px", "fontSize": "13px"},
        page_size=8,
        style_table={"overflowX": "auto"},
        style_header={"fontWeight": "bold"},)

    meta = {"current_file_id": current_id}

    msg = f"Uploaded {added_count} file(s). Total in session: {len(files)}."
    color = "success"
    if invalid_count:
        msg += f" {invalid_count} file(s) had missing/invalid run date in row 1."
        color = "warning"

    #Reset comparison outputs on new upload

    return (
        {"session_id": session_id},
        files,
        meta,
        msg,
        color,
        current_alert,
        ref_options,
        None,
        files_table,
        None,
        None,
        [],
        None,
        "Run comparison first to generate a report.",
        "secondary",
        None, # anomaly_records_store
        None,
        "",
        {"display": "block"} if manual_mode else {"display": "none"},  # manual_current_selection_wrapper style
        current_options,  # ref_current_dropdown options
        date_check_mode  # date_check_mode_store
        )


@app.callback(
    Output("ref_meta_store", "data", allow_duplicate=True),
    Output("ref_current_main_alert", "children", allow_duplicate=True),
    Output("ref_reference_dropdown", "options", allow_duplicate=True),
    Output("ref_reference_dropdown", "value", allow_duplicate=True),
    Input("ref_current_dropdown", "value"),
    State("ref_files_store", "data"),
    prevent_initial_call=True,
)
def handle_manual_current_selection(current_file_id, files_store):
    """Handle manual current file selection when date check fails"""
    if not current_file_id or not files_store:
        return no_update, no_update, no_update, no_update
    
    files_by_id = {f["file_id"]: f for f in files_store}
    current = files_by_id.get(current_file_id)
    
    if not current:
        return no_update, no_update, no_update, no_update
    
    # Update current alert
    current_alert = _current_main_alert_content(
        current["filename"],
        current.get("run_date_display", ""))
    
    # Populate Previous dropdown with remaining valid files
    valid_files = [f for f in files_store if f.get("valid") and f.get("run_date_iso")]
    ref_options = []
    for f in valid_files:
        if f["file_id"] != current_file_id:
            ref_options.append({
                "label": f"{f['filename']} (Run: {f.get('run_date_display', '')})",
                "value": f["file_id"]
            })
    
    return (
        {"current_file_id": current_file_id},
        current_alert,
        ref_options,
        None  # Reset reference dropdown value
    )

@app.callback(
Output("diff_store", "data", allow_duplicate=True),
Output("summary_cards_area", "children", allow_duplicate=True),
Output("anomaly_table", "data", allow_duplicate=True),
Output("report_path_store", "data", allow_duplicate=True),
Output("download_hint", "children", allow_duplicate=True),
Output("download_hint", "color", allow_duplicate=True),
Output("anomaly_records_store", "data", allow_duplicate=True),
Output("active_filter_store", "data", allow_duplicate=True),
Output("active_filter_hint", "children", allow_duplicate=True),
Input("run_compare_btn", "n_clicks"),
State("session_store", "data"),
State("ref_files_store", "data"),
State("ref_meta_store", "data"),
State("ref_reference_dropdown", "value"),
State("compare_columns_dropdown", "value"),
State("main_header_override", "value"),
State("ref_header_override", "value"),
prevent_initial_call=True,)

def run_comparison(n_clicks,session_data,files_store,meta_store,ref_file_id,compare_cols_selected,main_hdr_override,ref_hdr_override,):
    if not session_data or not session_data.get("session_id"):
        return (
            no_update, no_update, no_update, no_update,
            "Run comparison first to generate a report.", "secondary",
            no_update, no_update, no_update,)

    current_id = (meta_store or {}).get("current_file_id")

    if not current_id or not files_store:
        return (
            no_update, no_update, no_update, no_update,
            "Run comparison first to generate a report.", "secondary",
            no_update, no_update, no_update,)

    if not ref_file_id:
        return (no_update, no_update, no_update, no_update, "Run comparison first to generate a report.", "secondary", no_update, no_update, no_update,)

    files_by_id = {f["file_id"]: f for f in files_store}
    main = files_by_id.get(current_id)
    ref = files_by_id.get(ref_file_id)
    
    if not main or not ref:
        return (no_update, no_update, no_update, no_update, "Run comparison first to generate a report.", "secondary", no_update, no_update, no_update,)
    
    compare_cols = compare_cols_selected if compare_cols_selected else default_compare_columns()

    try:
        expected_for_detection = EXPECTED_COLUMNS_DEFAULT
        
        # Parallelize header detection for both files
        from concurrent.futures import ThreadPoolExecutor
        
        if main_hdr_override and ref_hdr_override:
            # Both overridden, no need for parallel detection
            main_header_row = int(main_hdr_override)
            ref_header_row = int(ref_hdr_override)
        elif main_hdr_override:
            # Only main overridden
            main_header_row = int(main_hdr_override)
            ref_header_row = detect_header_row(
                ref["path"], expected_for_detection, max_rows=HEADER_SCAN_ROWS_MAX, max_cols=HEADER_SCAN_COLS_MAX
            )
        elif ref_hdr_override:
            # Only ref overridden
            ref_header_row = int(ref_hdr_override)
            main_header_row = detect_header_row(
                main["path"], expected_for_detection, max_rows=HEADER_SCAN_ROWS_MAX, max_cols=HEADER_SCAN_COLS_MAX
            )
        else:
            # Both need detection - run in parallel
            with ThreadPoolExecutor(max_workers=2) as executor:
                fut_main = executor.submit(
                    detect_header_row,
                    main["path"], 
                    expected_for_detection, 
                    max_rows=HEADER_SCAN_ROWS_MAX, 
                    max_cols=HEADER_SCAN_COLS_MAX
                )
                fut_ref = executor.submit(
                    detect_header_row,
                    ref["path"], 
                    expected_for_detection, 
                    max_rows=HEADER_SCAN_ROWS_MAX, 
                    max_cols=HEADER_SCAN_COLS_MAX
                )
                
                main_header_row = fut_main.result()
                ref_header_row = fut_ref.result()

    except Exception as e:
        return (
            no_update, no_update, no_update, no_update,
            f"Error detecting header row: {str(e)}", "danger",
            no_update, no_update, no_update,
            )


    try:
        result = run_reference_check(
            main_path=main ["path"],
            ref_path=ref["path"],
            key_column=KEY_COLUMN,
            compare_columns=compare_cols,
            main_header_row=main_header_row,
            ref_header_row=ref_header_row,
            main_filename=main["filename"],
            ref_filename=ref["filename"],
            main_run_date=main.get("run_date_iso"),
            ref_run_date=ref.get("run_date_iso"),)
    except Exception as e:
        return (no_update, no_update, no_update, no_update,
                f"Error running comparison: {str(e)}", "danger",
                no_update, no_update, no_update,
        )

    summary = result["summary"]
    anomalies_df = result["anomalies_df"]

    # Report

    session_id = session_data["session_id"]
    out_dir = ensure_session_dir(session_id)
    report_path = os.path.join(out_dir, f"anomaly_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx")

    try:
        write_anomaly_report_xlsx(report_path, summary, anomalies_df)
    except Exception as e:
        return (
            no_update, no_update, no_update, no_update,
            "Run comparison first to generate a report.", "secondary",
            no_update, no_update, no_update,)

    status_msg = (
        f"Done. Headers > Main row {main_header_row}, Reference row {ref_header_row}."
        f"Report: {os.path.basename(report_path)}"
    )

    # Only 3 cards now + start with no filter
    active_filter = None
    summary_ui = _summary_cards_clickable(summary, active_filter)
    
    # Store the displayed anomalies for fast client-side-ish filtering
    anomalies_records = anomalies_df.head(5000).to_dict("records")
    diff_store = {"summary": summary, "anomalies_count": int(len(anomalies_df))}
    
    return (
        diff_store,
        summary_ui,
        anomalies_records,
        {"report_path": report_path},
        f"Report ready: {os.path.basename (report_path)}",
        "success",
        anomalies_records,
        active_filter,
        "Showing: All changes (click a card to filter, click again to reset).",)

@app.callback(
    Output("active_filter_store", "data", allow_duplicate=True),
    Output("anomaly_table", "data", allow_duplicate=True),
    Output("summary_cards_area", "children", allow_duplicate=True),
    Output("active_filter_hint", "children", allow_duplicate=True),
    Input("card_added", "n_clicks"),
    Input("card_deleted", "n_clicks"),
    Input("card_modified", "n_clicks"),
    State("active_filter_store", "data"),
    State("anomaly_records_store", "data"),
    State("diff_store", "data"),
    prevent_initial_call=True,)

def filter_by_card(n_added, n_deleted, n_modified, current_filter, records, diff_store):
    if not records or not diff_store or not diff_store.get("summary"):
        return no_update, no_update, no_update, no_update

    trig = dash.ctx.triggered_id
    selected = None
    if trig == "card_added":
        selected = "added"
    elif trig == "card_deleted":
        selected = "deleted"
    elif trig == "card_modified":
        selected = "modified"

    #toggle off if clicking same active filter

    if selected == current_filter:
        new_filter = None
    else:
        new_filter = selected

    # filter records robustly on change_type text
    def _match(r):
        ct = str(r.get("change_type", "")).lower()
        if new_filter == "added":
            return "add" in ct or "new" in ct or ct == "insert"
        if new_filter == "deleted":
            return "delete" in ct or "removed" in ct or "drop" in ct
        if new_filter == "modified":
            return "mod" in ct or "update" in ct or "change" in ct
        return True

    filtered = [r for r in records if _match(r)] if new_filter else records
    summary = diff_store["summary"]
    cards = _summary_cards_clickable(summary, new_filter)

    hint = "Showing: All changes (click a card to filter, click again to reset)."
    if new_filter == "added":
        hint = "Showing: Added rows only (click again to reset)."
    elif new_filter == "deleted":
        hint = "Showing: Deleted rows only (click again to reset)."
    elif new_filter == "modified":
        hint = "Showing: Modified rows only (click again to reset)."

    return new_filter, filtered, cards, hint

@app.callback(
    Output("report_download", "data"),
    Output("download_hint", "children", allow_duplicate=True),
    Output("download_hint", "color", allow_duplicate=True),
    Input("download_btn", "n_clicks"),
    State("report_path_store", "data"),
    prevent_initial_call=True,)

def download_report(n_clicks, report_path_store):
    if not report_path_store or not report_path_store.get("report_path"):
        return no_update, "Run comparison first to generate a report.", "secondary"

    path = report_path_store["report_path"]
    if not os.path.exists (path):
        return no_update, "Report not found. Try running comparison again.", "warning"

    return dcc.send_file(path), f"Downloading: {os.path.basename(path)}", "primary"

# ============================================================================
# FINANCIAL TAB CALLBACKS
# ============================================================================

@app.callback(
    Output("fin_session_store", "data"),
    Output("fin_files_store", "data"),
    Output("fin_upload_status", "children"),
    Output("fin_upload_status", "color"),
    Output("fin_files_table_wrapper", "children"),
    Output("fin_current_dropdown", "options"),
    Output("fin_previous_dropdown", "options"),
    Output("fin_comparison_section", "style"),
    Output("fin_results_section", "style"),
    Input("fin_upload", "contents"),
    Input("fin_upload", "filename"),
    Input("fin_clear_session_btn", "n_clicks"),
    State("fin_session_store", "data"),
    State("fin_files_store", "data"),
    prevent_initial_call=True
)
def fin_handle_upload(contents_list, filename_list, clear_clicks, session_data, existing_files):
    """Handle financial file uploads with GBM/CMB validation"""
    triggered = dash.callback_context.triggered[0]["prop_id"].split(".")[0]
    
    if triggered == "fin_clear_session_btn":
        if session_data and session_data.get("session_id"):
            cleanup_session_dir(session_data["session_id"])
        
        return (
            None, None,
            "Upload 2 files to begin.", "info",
            dbc.Alert("No files uploaded yet.", color="secondary", className="mb-0"),
            [], [],
            {"display": "none"},
            {"display": "none"}
        )
    
    if not contents_list or not filename_list:
        return (no_update,) * 9
    
    session_id = (session_data or {}).get("session_id") or str(uuid.uuid4())
    ensure_session_dir(session_id)
    
    files = existing_files or []
    
    # Validate file count
    total_files = len(files) + len(filename_list)
    if total_files > 2:
        return (
            session_data, files,
            " Error: Maximum 2 files allowed. Please clear session and re-upload.", "danger",
            no_update, [], [],
            {"display": "none"},
            {"display": "none"}
        )
    
    # Validate filenames for GBM/CMB
    for fname in filename_list:
        fname_upper = fname.upper()
        has_gbm = "GBM" in fname_upper
        has_cmb = "CMB" in fname_upper
        
        if not has_gbm and not has_cmb:
            return (
                session_data, files,
                f" Error: Filename '{fname}' must contain either 'GBM' or 'CMB'.", "danger",
                no_update, [], [],
                {"display": "none"},
                {"display": "none"}
            )
        
        if has_gbm and has_cmb:
            return (
                session_data, files,
                f" Error: Filename '{fname}' cannot contain both 'GBM' and 'CMB'.", "danger",
                no_update, [], [],
                {"display": "none"},
                {"display": "none"}
            )
    
    # Check file type consistency
    all_filenames = [f["filename"] for f in files] + filename_list
    file_types = []
    for fname in all_filenames:
        fname_upper = fname.upper()
        if "GBM" in fname_upper:
            file_types.append("GBM")
        elif "CMB" in fname_upper:
            file_types.append("CMB")
    
    if len(set(file_types)) > 1:
        return (
            session_data, files,
            " Error: Cannot mix GBM and CMB files. All files must be the same type.", "danger",
            no_update, [], [],
            {"display": "none"},
            {"display": "none"}
        )
    
    # Save files
    for contents, fname in zip(contents_list, filename_list):
        file_id = str(uuid.uuid4())
        path = save_uploaded_xlsx(session_id, file_id, fname, contents)
        
        files.append({
            "file_id": file_id,
            "filename": fname,
            "path": path,
            "file_type": file_types[0] if file_types else "Unknown"
        })
    
    # Create file table
    table_rows = [{"filename": f["filename"], "type": f["file_type"]} for f in files]
    files_table = dash_table.DataTable(
        columns=[
            {"name": "Filename", "id": "filename"},
            {"name": "Type", "id": "type"}
        ],
        data=table_rows,
        style_cell={"padding": "8px", "fontSize": "13px"},
        style_header={"fontWeight": "bold"}
    )
    
    # Create dropdown options
    dropdown_opts = [{"label": f["filename"], "value": f["file_id"]} for f in files]
    
    msg = f" Uploaded {len(filename_list)} file(s). Total: {len(files)}/2 files."
    color = "success" if len(files) == 2 else "info"
    
    return (
        {"session_id": session_id},
        files,
        msg,
        color,
        files_table,
        dropdown_opts,
        dropdown_opts,
        {"display": "none"},
        {"display": "none"}
    )


@app.callback(
    Output("fin_comparison_section", "style", allow_duplicate=True),
    Output("fin_selection_status", "children"),
    Output("fin_selection_status", "color"),
    Output("fin_meta_store", "data"),
    Output("fin_validate_btn", "disabled"),
    Input("fin_current_dropdown", "value"),
    Input("fin_previous_dropdown", "value"),
    prevent_initial_call=True
)
def fin_toggle_comparison_section(current_id, previous_id):
    """Show comparison section when both files are selected"""
    if current_id and previous_id:
        if current_id == previous_id:
            return (
                {"display": "none"},
                " Error: Current and Previous files must be different.",
                "danger",
                None,
                True  # Keep validate button disabled
            )
        
        return (
            {"display": "none"},  # Keep hidden until validation passes
            " Files selected. Click 'Validate Data' to preview.",
            "success",
            {"current_file_id": current_id, "previous_file_id": previous_id},
            False  # Enable validate button
        )
    
    return (
        {"display": "none"},
        "Select both current and previous files to continue.",
        "info",
        None,
        True  # Keep validate button disabled
    )


@app.callback(
    Output("fin_validation_store", "data"),
    Output("fin_validation_preview", "children"),
    Output("fin_comparison_section", "style", allow_duplicate=True),
    Input("fin_validate_btn", "n_clicks"),
    State("fin_files_store", "data"),
    State("fin_meta_store", "data"),
    prevent_initial_call=True
)
def fin_validate_data(n_clicks, files_store, meta_store):
    """Validate data and show preview with duplicate information"""
    if not files_store or not meta_store:
        return None, None, {"display": "none"}
    
    current_id = meta_store.get("current_file_id")
    previous_id = meta_store.get("previous_file_id")
    
    if not current_id or not previous_id:
        return None, None, {"display": "none"}
    
    # Get file paths
    files_by_id = {f["file_id"]: f for f in files_store}
    current_file = files_by_id.get(current_id)
    previous_file = files_by_id.get(previous_id)
    
    if not current_file or not previous_file:
        return None, dbc.Alert("Error: File not found.", color="danger"), {"display": "none"}
    
    try:
        # Run validation (now reads files in parallel and returns prepared DataFrames)
        validation_result = validate_financial_files(
            current_file["path"],
            previous_file["path"],
            FINANCIAL_KEY_COLUMNS
        )
        
        # Extract DataFrames for caching
        df_current = validation_result.pop("df_current")
        df_previous = validation_result.pop("df_previous")
        
        # Cache the prepared DataFrames as JSON for reuse in analysis
        cache_data = {
            "current_file_id": current_id,
            "previous_file_id": previous_id,
            "df_current_json": df_current.to_json(orient='split'),
            "df_previous_json": df_previous.to_json(orient='split'),
            "stats": validation_result  # Stats without DataFrames
        }
        
        # Build preview UI
        preview_content = dbc.Card([
            dbc.CardHeader(html.H5(" Data Validation Preview", className="mb-0")),
            dbc.CardBody([
                dbc.Row([
                    dbc.Col([
                        html.H6("Current File", className="text-primary"),
                        html.P([
                            html.Strong("Total Rows: "), f"{validation_result['current_total_rows']:,}", html.Br(),
                            html.Strong("Unique Keys: "), f"{validation_result['current_unique_keys']:,}", html.Br(),
                            html.Strong("Duplicate Rows: "), 
                            html.Span(
                                f"{validation_result['current_duplicate_rows']:,}",
                                className="text-danger fw-bold" if validation_result['current_duplicate_rows'] > 0 else ""
                            )
                        ], className="mb-0")
                    ], md=6),
                    dbc.Col([
                        html.H6("Previous File", className="text-secondary"),
                        html.P([
                            html.Strong("Total Rows: "), f"{validation_result['previous_total_rows']:,}", html.Br(),
                            html.Strong("Unique Keys: "), f"{validation_result['previous_unique_keys']:,}", html.Br(),
                            html.Strong("Duplicate Rows: "), 
                            html.Span(
                                f"{validation_result['previous_duplicate_rows']:,}",
                                className="text-danger fw-bold" if validation_result['previous_duplicate_rows'] > 0 else ""
                            )
                        ], className="mb-0")
                    ], md=6)
                ]),
                
                # Show duplicate samples if any
                html.Div([
                    html.Hr(),
                    dbc.Alert([
                        html.H6(" Duplicates Detected", className="alert-heading"),
                        html.P("The following duplicate keys will be automatically removed (keeping first occurrence):", className="mb-2"),
                        html.Div([
                            html.Strong("Current File Samples:"),
                            html.Ul([html.Li(key) for key in validation_result['current_duplicate_samples']]) if validation_result['current_duplicate_samples'] else html.P("None", className="text-muted ms-3")
                        ]) if validation_result['current_duplicate_rows'] > 0 else None,
                        html.Div([
                            html.Strong("Previous File Samples:"),
                            html.Ul([html.Li(key) for key in validation_result['previous_duplicate_samples']]) if validation_result['previous_duplicate_samples'] else html.P("None", className="text-muted ms-3")
                        ]) if validation_result['previous_duplicate_rows'] > 0 else None
                    ], color="warning")
                ]) if validation_result['has_duplicates'] else None,
                
                dbc.Alert([
                    html.I(className="bi bi-check-circle me-2"),
                    "Validation passed! You can now proceed to run the analysis."
                ], color="success", className="mb-0 mt-3")
            ])
        ], className="shadow-sm")
        
        return (
            cache_data,
            preview_content,
            {"display": "block"}  # Show comparison section
        )
        
    except Exception as e:
        error_preview = dbc.Alert([
            html.H6(" Validation Failed", className="alert-heading"),
            html.P(str(e))
        ], color="danger")
        
        return None, error_preview, {"display": "none"}


@app.callback(
    Output("fin_results_store", "data"),
    Output("fin_report_path_store", "data"),
    Output("fin_analysis_status", "children"),
    Output("fin_analysis_status", "color"),
    Output("fin_results_section", "style", allow_duplicate=True),
    Input("fin_run_btn", "n_clicks"),
    State("fin_session_store", "data"),
    State("fin_files_store", "data"),
    State("fin_meta_store", "data"),
    State("fin_compare_columns_dropdown", "value"),
    State("fin_validation_store", "data"),
    prevent_initial_call=True
)
def fin_run_analysis(n_clicks, session_data, files_store, meta_store, compare_cols, validation_cache):
    """Run all three financial analyses and generate report"""
    if not session_data or not files_store or not meta_store:
        return (
            None, None,
            "Please upload and select files first.",
            "warning",
            {"display": "none"}
        )
    
    current_id = meta_store.get("current_file_id")
    previous_id = meta_store.get("previous_file_id")
    
    if not current_id or not previous_id:
        return (
            None, None,
            "Please select both current and previous files.",
            "warning",
            {"display": "none"}
        )
    
    # Get file paths
    files_by_id = {f["file_id"]: f for f in files_store}
    current_file = files_by_id.get(current_id)
    previous_file = files_by_id.get(previous_id)
    
    if not current_file or not previous_file:
        return (
            None, None,
            "Error: File not found.",
            "danger",
            {"display": "none"}
        )
    
    try:
        # Check if we have cached data from validation step
        cache_hit = (
            validation_cache and
            validation_cache.get("current_file_id") == current_id and
            validation_cache.get("previous_file_id") == previous_id and
            "df_current_json" in validation_cache and
            "df_previous_json" in validation_cache
        )
        
        if cache_hit:
            # Use cached DataFrames (avoids re-reading files!)
            import pandas as pd
            df_current = pd.read_json(validation_cache["df_current_json"], orient='split')
            df_previous = pd.read_json(validation_cache["df_previous_json"], orient='split')
        else:
            # Cache miss - read files (parallel read + inline header detection)
            from services.financial_engine import read_financial_files_parallel, _build_composite_key
            df_current, df_previous = read_financial_files_parallel(
                current_file["path"],
                previous_file["path"]
            )
            
            # Validate required columns
            for col in FINANCIAL_KEY_COLUMNS:
                if col not in df_current.columns:
                    raise ValueError(f"Column '{col}' not found in current file")
                if col not in df_previous.columns:
                    raise ValueError(f"Column '{col}' not found in previous file")
            
            # Build composite keys and de-duplicate
            df_current['_composite_key'] = _build_composite_key(df_current, FINANCIAL_KEY_COLUMNS)
            df_previous['_composite_key'] = _build_composite_key(df_previous, FINANCIAL_KEY_COLUMNS)
            
            if df_current['_composite_key'].duplicated().any():
                df_current = df_current.drop_duplicates(subset='_composite_key', keep='first')
            if df_previous['_composite_key'].duplicated().any():
                df_previous = df_previous.drop_duplicates(subset='_composite_key', keep='first')
        
        # Use selected compare columns or default
        compare_columns = compare_cols if compare_cols else FINANCIAL_NON_FINANCIAL_COLUMNS
        
        # Run analyses in parallel using ThreadPoolExecutor
        from concurrent.futures import ThreadPoolExecutor
        
        with ThreadPoolExecutor(max_workers=3) as executor:
            # Submit all three analyses concurrently
            fut_mastergroup = executor.submit(
                run_mastergroup_validation, 
                df_current, 
                FINANCIAL_FUZZY_THRESHOLD
            )
            fut_nonfinancial = executor.submit(
                run_non_financial_comparison,
                df_current, 
                df_previous,
                FINANCIAL_KEY_COLUMNS,
                compare_columns
            )
            fut_financial = executor.submit(
                run_financial_comparison,
                df_current, 
                df_previous,
                FINANCIAL_KEY_COLUMNS
            )
            
            # Wait for all to complete
            df_mastergroup = fut_mastergroup.result()
            df_nonfinancial = fut_nonfinancial.result()
            df_financial = fut_financial.result()
        
        # Build Consolidated Report (sequential - depends on all 3 results)
        df_consolidated = build_consolidated(
            df_mastergroup, df_nonfinancial, df_financial,
            FINANCIAL_KEY_COLUMNS
        )
        
        # Generate report
        session_id = session_data["session_id"]
        out_dir = ensure_session_dir(session_id)
        report_path = os.path.join(
            out_dir,
            f"financial_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
        )
        
        write_financial_report_xlsx(
            report_path,
            df_mastergroup,
            df_nonfinancial,
            df_financial,
            df_consolidated
        )
        
        # Store results for display
        results = {
            "mastergroup": df_mastergroup.to_dict("records"),
            "nonfinancial": df_nonfinancial.to_dict("records"),
            "financial": df_financial.to_dict("records"),
            "consolidated": df_consolidated.to_dict("records"),
            "summary": {
                "total_records": len(df_current),
                "matched": len(df_mastergroup[df_mastergroup["Match Status"] == "Matched"]),
                "not_matched": len(df_mastergroup[df_mastergroup["Match Status"] == "Not Matched"]),
                "added": len(df_nonfinancial[df_nonfinancial["Change Type"] == "Added"]) if not df_nonfinancial.empty else 0,
                "deleted": len(df_nonfinancial[df_nonfinancial["Change Type"] == "Deleted"]) if not df_nonfinancial.empty else 0,
                "modified": len(df_nonfinancial[df_nonfinancial["Change Type"] == "Modified"]) if not df_nonfinancial.empty else 0,
            }
        }
        
        summary_text = (
            f" Analysis complete! "
            f"Matched: {results['summary']['matched']}, "
            f"Not Matched: {results['summary']['not_matched']}, "
            f"Added: {results['summary']['added']}, "
            f"Modified: {results['summary']['modified']}, "
            f"Deleted: {results['summary']['deleted']}"
        )
        
        return (
            results,
            {"report_path": report_path},
            summary_text,
            "success",
            {"display": "block"}
        )
        
    except Exception as e:
        return (
            None, None,
            f" Error: {str(e)}",
            "danger",
            {"display": "none"}
        )


@app.callback(
    Output("fin_filter_section", "style"),
    Input("fin_results_tabs", "value"),
    prevent_initial_call=True
)
def fin_toggle_filter_section(tab_value):
    """Hide filter section for consolidated tab"""
    if tab_value == "tab_consolidated":
        return {"display": "none"}
    return {"display": "block"}


@app.callback(
    Output("fin_sub_filter", "data"),
    Output("fin_filter_summary", "children"),
    Input("fin_results_tabs", "value"),
    State("fin_results_store", "data"),
    prevent_initial_call=True
)
def fin_update_filter_options(tab_value, results_store):
    """Update filter summary cards based on selected tab"""
    if not results_store:
        return "all", []
    
    summary = results_store.get("summary", {})
    
    if tab_value == "tab_mastergroup":
        matched = summary.get("matched", 0)
        not_matched = summary.get("not_matched", 0)
        
        cards = [
            dbc.Card(
                dbc.CardBody([
                    html.H4(matched + not_matched, className="mb-0"),
                    html.P("Total Records", className="text-muted mb-0 small")
                ]),
                className="text-center",
                style={"cursor": "default"},
                id={"type": "fin_filter_card", "index": "all"},
                n_clicks=0
            ),
            dbc.Card(
                dbc.CardBody([
                    html.H4(matched, className="mb-0 text-success"),
                    html.P("Matched", className="text-muted mb-0 small")
                ]),
                className="text-center",
                style={"cursor": "pointer", "transition": "all 0.2s"},
                id={"type": "fin_filter_card", "index": "Matched"},
                n_clicks=0
            ),
            dbc.Card(
                dbc.CardBody([
                    html.H4(not_matched, className="mb-0 text-warning"),
                    html.P("Not Matched", className="text-muted mb-0 small")
                ]),
                className="text-center",
                style={"cursor": "pointer", "transition": "all 0.2s"},
                id={"type": "fin_filter_card", "index": "Not Matched"},
                n_clicks=0
            )
        ]
        return "all", dbc.Row([dbc.Col(card, md=4) for card in cards], className="g-2")
    
    elif tab_value == "tab_nonfinancial":
        added = summary.get("added", 0)
        modified = summary.get("modified", 0)
        deleted = summary.get("deleted", 0)
        
        cards = [
            dbc.Card(
                dbc.CardBody([
                    html.H4(added + modified + deleted, className="mb-0"),
                    html.P("Total Changes", className="text-muted mb-0 small")
                ]),
                className="text-center",
                style={"cursor": "default"},
                id={"type": "fin_filter_card", "index": "all"},
                n_clicks=0
            ),
            dbc.Card(
                dbc.CardBody([
                    html.H4(added, className="mb-0 text-success"),
                    html.P("Added", className="text-muted mb-0 small")
                ]),
                className="text-center",
                style={"cursor": "pointer", "transition": "all 0.2s"},
                id={"type": "fin_filter_card", "index": "Added"},
                n_clicks=0
            ),
            dbc.Card(
                dbc.CardBody([
                    html.H4(modified, className="mb-0 text-info"),
                    html.P("Modified", className="text-muted mb-0 small")
                ]),
                className="text-center",
                style={"cursor": "pointer", "transition": "all 0.2s"},
                id={"type": "fin_filter_card", "index": "Modified"},
                n_clicks=0
            ),
            dbc.Card(
                dbc.CardBody([
                    html.H4(deleted, className="mb-0 text-danger"),
                    html.P("Deleted", className="text-muted mb-0 small")
                ]),
                className="text-center",
                style={"cursor": "pointer", "transition": "all 0.2s"},
                id={"type": "fin_filter_card", "index": "Deleted"},
                n_clicks=0
            )
        ]
        return "all", dbc.Row([dbc.Col(card, md=3) for card in cards], className="g-2")
    
    elif tab_value == "tab_financial":
        # Count TOI statuses using exact terms
        fin_data = results_store.get("financial", [])
        status_counts = {}
        for r in fin_data:
            status = r.get("TOI Status", "")
            status_counts[status] = status_counts.get(status, 0) + 1
        
        # Create cards for each unique status
        cards = [
            dbc.Card(
                dbc.CardBody([
                    html.H4(len(fin_data), className="mb-0"),
                    html.P("Total Records", className="text-muted mb-0 small")
                ]),
                className="text-center",
                style={"cursor": "default"},
                id={"type": "fin_filter_card", "index": "all"}
            )
        ]
        
        # Color mapping for different statuses
        color_map = {
            "Increased in current file": "success",
            "Decreased in current file": "danger",
            "No TOI change in previous file and current file": "secondary",
            "No TOI data in current and previous data for this Site Customer": "warning",
            "No details of Site Customer in previous file": "info",
            "No details of Site Customer in current file": "dark"
        }
        
        for status, count in sorted(status_counts.items()):
            color = color_map.get(status, "primary")
            cards.append(
                dbc.Card(
                    dbc.CardBody([
                        html.H4(count, className=f"mb-0 text-{color}"),
                        html.P(status, className="text-muted mb-0 small", style={"fontSize": "11px"})
                    ]),
                    className="text-center",
                    style={"cursor": "pointer", "transition": "all 0.2s"},
                    id={"type": "fin_filter_card", "index": status},
                    n_clicks=0
                )
            )
        
        return "all", dbc.Row([dbc.Col(card, md=2) for card in cards], className="g-2")
    
    # Consolidated tab - no filter
    return "all", []



# Callback to handle card clicks for filtering
@app.callback(
    Output("fin_sub_filter", "data", allow_duplicate=True),
    Input({"type": "fin_filter_card", "index": ALL}, "n_clicks"),
    State({"type": "fin_filter_card", "index": ALL}, "id"),
    State("fin_sub_filter", "data"),
    prevent_initial_call=True
)
def fin_handle_card_click(n_clicks_list, card_ids, current_filter):
    """Handle clicks on summary cards to filter data"""
    if not any(n_clicks_list):
        raise PreventUpdate
    
    # Find which card was clicked
    ctx = callback_context
    if not ctx.triggered:
        raise PreventUpdate
    
    triggered_id = ctx.triggered[0]["prop_id"].split(".")[0]
    if triggered_id:
        import json
        card_id = json.loads(triggered_id)
        clicked_index = card_id["index"]
        
        # Toggle behavior: if clicking the same filter, reset to "all"
        if current_filter == clicked_index:
            return "all"
        else:
            return clicked_index
    
    raise PreventUpdate


# Callback to toggle tab visibility based on selected tab
@app.callback(
    Output("fin_tab_mastergroup_content", "style"),
    Output("fin_tab_nonfinancial_content", "style"),
    Output("fin_tab_financial_content", "style"),
    Output("fin_tab_consolidated_content", "style"),
    Input("fin_results_tabs", "value"),
    prevent_initial_call=True
)
def fin_toggle_tab_visibility(tab_value):
    """Toggle visibility of tab content divs using CSS"""
    styles = {
        "tab_mastergroup": ({"display": "block"}, {"display": "none"}, {"display": "none"}, {"display": "none"}),
        "tab_nonfinancial": ({"display": "none"}, {"display": "block"}, {"display": "none"}, {"display": "none"}),
        "tab_financial": ({"display": "none"}, {"display": "none"}, {"display": "block"}, {"display": "none"}),
        "tab_consolidated": ({"display": "none"}, {"display": "none"}, {"display": "none"}, {"display": "block"})
    }
    return styles.get(tab_value, ({"display": "block"}, {"display": "none"}, {"display": "none"}, {"display": "none"}))


# Helper function to create DataTable with common styling (limited to 1000 rows)
def _create_financial_datatable(data, display_cols):
    """Create a DataTable with consistent styling - limited to 1000 rows for performance"""
    if not data:
        return dbc.Alert("No data available.", color="secondary")
    
    # Limit to first 1000 rows for performance
    data = data[:1000]
    
    # Filter data to only include display columns
    filtered_data = []
    for row in data:
        filtered_row = {col: row.get(col, "") for col in display_cols if col in row}
        filtered_data.append(filtered_row)
    
    if not filtered_data:
        return dbc.Alert("No data available with the selected columns.", color="warning")
    
    columns = [{"name": k, "id": k} for k in display_cols if k in filtered_data[0]]
    
    return dash_table.DataTable(
        columns=columns,
        data=filtered_data,
        page_size=20,
        filter_action="native",
        sort_action="native",
        style_table={"overflowX": "auto"},
        style_cell={
            "padding": "8px",
            "fontSize": "13px",
            "minWidth": "100px",
            "maxWidth": "300px",
            "whiteSpace": "normal",
            "height": "auto",
            "textOverflow": "ellipsis"
        },
        style_data={
            "whiteSpace": "normal",
            "height": "auto",
        },
        style_header={
            "backgroundColor": "#f8f9fa",
            "fontWeight": "bold",
            "whiteSpace": "normal",
            "height": "auto"
        },
        tooltip_data=[
            {col: {"value": str(row.get(col, "")), "type": "markdown"}
             for col in display_cols if col in row}
            for row in filtered_data
        ],
        tooltip_duration=None,
        css=[{"selector": ".dash-table-tooltip", "rule": "background-color: #333; color: white; font-size: 12px; max-width: 400px;"}]
    )


# Mastergroup tab rendering with filtering (renders once, then only filters)
@app.callback(
    Output("fin_tab_mastergroup_content", "children"),
    Input("fin_results_store", "data"),
    Input("fin_sub_filter", "data"),
    State("fin_results_tabs", "value"),
    prevent_initial_call=True
)
def fin_render_mastergroup_tab(results_store, filter_value, current_tab):
    """Render mastergroup tab with filtering"""
    if not results_store:
        return no_update
    
    data = results_store.get("mastergroup", [])
    if not data:
        return dbc.Alert("No mastergroup data available.", color="secondary")
    
    # Apply filter if needed
    if current_tab == "tab_mastergroup" and filter_value and filter_value != "all":
        data = [r for r in data if r.get("Match Status") == filter_value]
    
    if not data:
        return dbc.Alert(f"No records found for filter: {filter_value}", color="info")
    
    display_cols = ["Site Customer Number", "Site Customer Name", "Site Code", "Mastergroup Name", "Fuzzy Score", "Match Status"]
    return _create_financial_datatable(data, display_cols)


# Non-Financial tab rendering with filtering
@app.callback(
    Output("fin_tab_nonfinancial_content", "children"),
    Input("fin_results_store", "data"),
    Input("fin_sub_filter", "data"),
    State("fin_results_tabs", "value"),
    prevent_initial_call=True
)
def fin_render_nonfinancial_tab(results_store, filter_value, current_tab):
    """Render non-financial tab with filtering"""
    if not results_store:
        return no_update
    
    data = results_store.get("nonfinancial", [])
    if not data:
        return dbc.Alert("No non-financial changes detected.", color="info")
    
    # Apply filter if needed
    if current_tab == "tab_nonfinancial" and filter_value and filter_value != "all":
        data = [r for r in data if r.get("Change Type") == filter_value]
    
    if not data:
        return dbc.Alert(f"No records found for filter: {filter_value}", color="info")
    
    display_cols = ["Change Type", "Site Customer Number", "Site Customer Name", "Site Code", "Changed Fields", "Details"]
    return _create_financial_datatable(data, display_cols)


# Financial tab rendering with filtering
@app.callback(
    Output("fin_tab_financial_content", "children"),
    Input("fin_results_store", "data"),
    Input("fin_sub_filter", "data"),
    State("fin_results_tabs", "value"),
    prevent_initial_call=True
)
def fin_render_financial_tab(results_store, filter_value, current_tab):
    """Render financial tab with filtering"""
    if not results_store:
        return no_update
    
    data = results_store.get("financial", [])
    if not data:
        return dbc.Alert("No financial data available.", color="secondary")
    
    # Apply filter if needed using exact status match
    if current_tab == "tab_financial" and filter_value and filter_value != "all":
        data = [r for r in data if r.get("TOI Status") == filter_value]
    
    if not data:
        return dbc.Alert(f"No records found for filter: {filter_value}", color="info")
    
    display_cols = ["Site Customer Number", "Site Customer Name", "Site Code", "TOI Previous", "TOI Current", "TOI Difference", "TOI Status"]
    return _create_financial_datatable(data, display_cols)


# Consolidated tab rendering (no filtering)
@app.callback(
    Output("fin_tab_consolidated_content", "children"),
    Input("fin_results_store", "data"),
    prevent_initial_call=True
)
def fin_render_consolidated_tab(results_store):
    """Render consolidated tab (no filtering) - limited to 1000 rows"""
    if not results_store:
        return no_update
    
    data = results_store.get("consolidated", [])
    if not data:
        return dbc.Alert("No consolidated data available.", color="secondary")
    
    # Limit to first 1000 rows for performance
    data = data[:1000]
    
    # Show all columns for consolidated view
    columns = [{"name": k, "id": k} for k in data[0].keys()]
    return dash_table.DataTable(
        columns=columns,
        data=data,
        page_size=20,
        filter_action="native",
        sort_action="native",
        style_table={"overflowX": "auto"},
        style_cell={
            "padding": "8px",
            "fontSize": "13px",
            "minWidth": "100px",
            "maxWidth": "300px",
            "whiteSpace": "normal",
            "height": "auto",
            "textOverflow": "ellipsis"
        },
        style_data={
            "whiteSpace": "normal",
            "height": "auto",
        },
        style_header={
            "backgroundColor": "#f8f9fa",
            "fontWeight": "bold",
            "whiteSpace": "normal",
            "height": "auto"
        },
        tooltip_data=[
            {col: {"value": str(row.get(col, "")), "type": "markdown"}
             for col in data[0].keys()}
            for row in data
        ],
        tooltip_duration=None,
        css=[{"selector": ".dash-table-tooltip", "rule": "background-color: #333; color: white; font-size: 12px; max-width: 400px;"}]
    )




@app.callback(
    Output("fin_report_download", "data"),
    Output("fin_download_status", "children"),
    Output("fin_download_status", "color"),
    Input("fin_download_btn", "n_clicks"),
    State("fin_report_path_store", "data"),
    prevent_initial_call=True
)
def fin_download_report(n_clicks, report_path_store):
    """Download the generated financial report"""
    if not report_path_store or not report_path_store.get("report_path"):
        return no_update, "Run analysis first to generate a report.", "warning"
    
    path = report_path_store["report_path"]
    if not os.path.exists(path):
        return no_update, "Report not found. Try running analysis again.", "danger"
    
    return dcc.send_file(path), f"Downloading: {os.path.basename(path)}", "success"



if __name__ == "__main__":
    # Function to open browser after a short delay
    def open_browser():
        webbrowser.open_new("http://127.0.0.1:8050/")
    
    # Only open browser if not in reloader process (prevents double tabs in debug mode)
    if os.environ.get("WERKZEUG_RUN_MAIN") != "true":
        timer = threading.Timer(1.5, open_browser)
        timer.daemon = True
        timer.start()
    
    # Run the Dash server
    app.run_server(debug=True)
