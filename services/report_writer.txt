from typing import Dict, List, Optional, Any
import pandas as pd
from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill, Alignment
from openpyxl.utils.dataframe import dataframe_to_rows

FILL_ADDED = PatternFill("solid", fgColor="C6EFCE")
FILL_DELETED = PatternFill("solid", fgColor="FFC7CE")
FILL_MODIFIED = PatternFill("solid", fgColor="FFEB9C")

HEADER_FONT = Font(bold=True)
CENTER = Alignment(horizontal="center", vertical="center")

def write_anomaly_report_xlsx(path: str, summary: Dict, anomalies_df: pd.DataFrame) -> None:
    wb = Workbook()
    ws_summary = wb.active
    ws_summary.title = "Summary"
    
    summary_rows = [
        ("Main file", summary.get("main_file", "")),
        ("Reference file", summary.get("ref_file", "")),
        ("Key column",summary.get("key_column", [])),
        ("Compared columns", ",".join(summary.get("compared_columns", []))),
        ("Added rows", summary.get("added_rows", 0)),
        ("Deleted rows", summary.get("deleted_rows", 0)),
        ("Modified rows", summary.get("modified_rows", 0)),
    ]

    ws_summary.append(("Metric", "Value"))
    ws_summary["A1"].font = HEADER_FONT
    ws_summary["B1"].font = HEADER_FONT

    for k,v in summary_rows:
        ws_summary.append((k, v))

    ws_summary.column_dimensions["A"].width = 28
    ws_summary.column_dimensions["B"].width = 80

    ws_details = wb.create_sheet(title="Anomalies")
    if anomalies_df.empty or anomalies_df.shape[0] == 0:
        ws_details.append(("No anomalies detected"))
        wb.save(path)
        return
    
    for r_idx, row in enumerate(dataframe_to_rows(anomalies_df, index=False, header=True), 1):
        ws_details.append(row)
        if r_idx == 1:
            for c_idx in range(1, len(row) + 1):
                ws_details.cell(row=r_idx, column=c_idx).font = HEADER_FONT
                ws_details.cell(row=r_idx, column=c_idx).alignment = CENTER
                ws_details.column_dimensions[chr(64 + c_idx)].width = 20
    
    change_col = 1
    for r in range(2, ws_details.max_row + 1):
        change_type = ws_details.cell(row=r, column=change_col).value
        if change_type == "Added":
            fill = FILL_ADDED
        elif change_type == "Deleted":
            fill = FILL_DELETED
        elif change_type == "Modified":
            fill = FILL_MODIFIED

        if fill:
            for c in range(1, ws_details.max_column + 1):
                ws_details.cell(row=r, column=c).fill = fill
                ws_details.cell(row=r, column=c).alignment = Alignment(vertical="top",wrap_text=True)

    widths = [12,24,22,35,35]

    for i, width in enumerate(widths, 1):
        ws_details.column_dimensions[chr(64 + i)].width = width

    wb.save(path)