from typing import Dict, List, Optional, Any
import pandas as pd
from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill, Alignment
from openpyxl.utils.dataframe import dataframe_to_rows

FILL_ADDED = PatternFill("solid", fgColor="C6EFCE")
FILL_DELETED = PatternFill("solid", fgColor="FFC7CE")
FILL_MODIFIED = PatternFill("solid", fgColor="FFEB9C")

HEADER_FONT = Font(bold=True)
CENTER = Alignment(horizontal="center", vertical="center")

def write_anomaly_report_xlsx(path: str, summary: Dict, anomalies_df: pd.DataFrame) -> None:
    wb = Workbook()
    ws_summary = wb.active
    ws_summary.title = "Summary"
    
    summary_rows = [
        ("Main file", summary.get("main_file", "")),
        ("Reference file", summary.get("ref_file", "")),
        ("Key column",summary.get("key_column", [])),
        ("Compared columns", ",".join(summary.get("compared_columns", []))),
        ("Added rows", summary.get("added_rows", 0)),
        ("Deleted rows", summary.get("deleted_rows", 0)),
        ("Modified rows", summary.get("modified_rows", 0)),
    ]

    ws_summary.append(("Metric", "Value"))
    ws_summary["A1"].font = HEADER_FONT
    ws_summary["B1"].font = HEADER_FONT

    for k,v in summary_rows:
        ws_summary.append((k, v))

    ws_summary.column_dimensions["A"].width = 28
    ws_summary.column_dimensions["B"].width = 80

    # Create 3 separate sheets for each change type
    change_types = [
        ("Added", FILL_ADDED),
        ("Modified", FILL_MODIFIED),
        ("Deleted", FILL_DELETED)
    ]
    
    for sheet_name, fill_color in change_types:
        ws = wb.create_sheet(title=sheet_name)
        
        # Filter data for this change type
        filtered_df = anomalies_df[anomalies_df["change_type"] == sheet_name] if not anomalies_df.empty else pd.DataFrame()
        
        if filtered_df.empty:
            ws.append([f"No {sheet_name.lower()} rows"])
            ws["A1"].font = HEADER_FONT
        else:
            # Write headers and data
            for r_idx, row in enumerate(dataframe_to_rows(filtered_df, index=False, header=True), 1):
                ws.append(row)
                if r_idx == 1:
                    # Style headers
                    for c_idx in range(1, len(row) + 1):
                        ws.cell(row=r_idx, column=c_idx).font = HEADER_FONT
                        ws.cell(row=r_idx, column=c_idx).alignment = CENTER
                else:
                    # Apply fill color to data rows
                    for c_idx in range(1, len(row) + 1):
                        ws.cell(row=r_idx, column=c_idx).fill = fill_color
                        ws.cell(row=r_idx, column=c_idx).alignment = Alignment(vertical="top", wrap_text=True)
            
            # Set column widths
            widths = [12, 24, 22, 35, 35]
            for i, width in enumerate(widths, 1):
                if i <= len(widths):
                    ws.column_dimensions[chr(64 + i)].width = width

    wb.save(path)
